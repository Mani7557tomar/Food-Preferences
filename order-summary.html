<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Summary | The Food Corner</title>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding-bottom: 120px;
      background: #fff5f0;
    }

    header {
      background: #ff3d00;
      color: white;
      padding: 15px 20px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
    }

    .order-summary {
      padding: 20px;
    }

    .order-summary h2 {
      color: #e65100;
    }

    .item-list {
      margin-bottom: 20px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    .item-details {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
    }

    .item span {
      font-weight: bold;
    }

    .remove-btn {
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .remove-btn:hover {
      background: #c62828;
    }

    .total {
      font-size: 18px;
      font-weight: bold;
      text-align: right;
      margin-bottom: 20px;
    }

    .payment-dropdown {
      margin-bottom: 20px;
    }

    select, textarea {
      width: 90%;
      padding: 10px;
      font-size: 16px;
      margin-top: 5px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    label {
      font-weight: bold;
    }

    #confirmOrderBtn {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ff3d00;
      color: white;
      font-size: 18px;
      padding: 15px;
      text-align: center;
      border: none;
      cursor: pointer;
      z-index: 1000;
    }

    /* Modal Styles */
    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    .qr-modal-content {
      background: white;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .qr-modal button {
      background: #ff3d00;
      color: white;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
    }

    .qr-modal button:hover {
      background: #e65100;
    }
  </style>
</head>
<body>

  <header>
    The Food Corner
  </header>

  <div class="order-summary">
    <h2>Order Summary</h2>

    <div class="item-list" id="orderItems"></div>

    <div class="total" id="totalPrice">Total: ₹0</div>

    <div class="payment-dropdown">
      <label for="paymentMethod">Mode of Payment:</label>
      <select id="paymentMethod" required>
        <option value="">-- Select Payment Method --</option>
        <option value="Cash on Delivery">Cash on Delivery</option>
        <option value="Online Payment">Online Payment</option>
      </select>
    </div>

    <div class="address-input">
      <label for="deliveryAddress">Delivery Address:</label>
      <textarea id="deliveryAddress" rows="3" placeholder="Enter full address..." required></textarea>
    </div>
  </div>

  <button id="confirmOrderBtn" onclick="confirmOrder()">Confirm Order</button>

  <!-- QR Code Modal -->
  <div class="qr-modal" id="qrModal">
    <div class="qr-modal-content">
      <h3>Scan QR Code to Pay</h3>
      <div id="qrCode"></div>
      <button onclick="closeQRModal()">Close</button>
    </div>
  </div>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function renderOrderItems() {
      const orderItemsContainer = document.getElementById('orderItems');
      orderItemsContainer.innerHTML = ''; // Clear previous content
      let totalPrice = 0;

      // If cart is empty
      if (cart.length === 0) {
        orderItemsContainer.innerHTML = "<p>No items in your order.</p>";
        document.getElementById("totalPrice").innerText = "Total: ₹0";
        return;
      }

      // Loop through cart items and display them
      cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        totalPrice += itemTotal;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';

        const imagePath = `assets/${item.name.replace(/\s+/g, '_')}.png`;

        itemDiv.innerHTML = `
          <div class="item-details">
            <img src="${imagePath}" alt="${item.name}" onerror="this.onerror=null;this.src='assets/default.png';" />
            <span>${item.name} x${item.qty}</span>
          </div>
          <div>
            <span>₹${itemTotal}</span><br/>
            <button class="remove-btn" onclick="removeItem(${index})">Remove</button>
          </div>
        `;
        orderItemsContainer.appendChild(itemDiv);
      });

      // Update the total price
      document.getElementById("totalPrice").innerText = `Total: ₹${totalPrice}`;
    }

    function removeItem(index) {
      // Remove item from cart array
      cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));  // Update cart in localStorage
      renderOrderItems();  // Re-render the items
    }

    function confirmOrder() {
      const paymentMethod = document.getElementById('paymentMethod').value;
      const address = document.getElementById('deliveryAddress').value.trim();

      if (!paymentMethod) {
        alert('Please select a payment method.');
        return;
      }

      if (!address) {
        alert('Please enter the delivery address.');
        return;
      }

      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }

      if (paymentMethod === "Online Payment") {
        // Generate QR code for payment
        generateQRCode();
      } else {
        proceedWithOrder(paymentMethod, address);
      }
    }

    function generateQRCode() {
      const totalAmount = document.getElementById('totalPrice').innerText.split('₹')[1];
      const qrContent = `Payment for Order - ₹${totalAmount} at The Food Corner. Please scan to pay.`;
      const qrCodeElement = document.getElementById('qrCode');

      // Clear existing QR code if any
      qrCodeElement.innerHTML = '';

      // Create new QR code
      const qrCode = new QRCode(qrCodeElement, {
        text: qrContent,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      // Show the modal
      document.getElementById('qrModal').style.display = 'flex';
    }

    function closeQRModal() {
      document.getElementById('qrModal').style.display = 'none';
    }

    function proceedWithOrder(paymentMethod, address) {
      const userName = localStorage.getItem('userName') || 'Guest';
      const userMobile = localStorage.getItem('userMobile') || 'N/A';
      const orderTime = new Date().toLocaleString();

      const payload = {
        name: userName,
        mobile: userMobile,
        paymentMethod: paymentMethod,
        address: address,
        items: cart,
        orderTime: orderTime
      };

      fetch('https://script.google.com/macros/s/AKfycbxYyc_8N4nCyXX6rmA8BqNeg4KFFIi8tumi5ltIDt4U56VDmrXY8yby-ZSe3qn-LI6X/exec', {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.text())
      .then(response => {
        if (response.includes("Success")) {
          alert(`Order confirmed! Payment method: ${paymentMethod}`);
          localStorage.removeItem('cart');
          window.location.href = 'thank-you.html';
        } else {
          alert("Something went wrong: " + response);
        }
      })
      .catch(err => {
        alert("Error sending order: " + err);
      });
    }

    renderOrderItems();
  </script>

</body>
</html>
